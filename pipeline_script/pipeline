pipeline{
    agent any
    
    parameters{
        string(name: 'ECR_REPO_NAME', defaultValue: 'ott-platform-prime', description: 'Enter the ECR repository name')
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Enter the image tag')
        string(name: 'AWS_REGION', defaultValue: 'ap-southeast-1', description: 'Enter the AWS region')
        string(name: 'AWS_ACCOUNT_ID', defaultValue: '859384797911', description: 'Enter the AWS account ID')
    }
    environment {
        SONARQUBE_SCANNER_HOME = tool 'sonar-scanner'
    }

    tools {
        nodejs "nodejs-16.20.0"
        jdk "jdk17"
    }


    stages{
        stage('Checkout Stage') {
            steps {
                git branch: 'main', url: 'https://github.com/krishnalogs/ott-platform-prime.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('Sonarqube Analysis') {
            steps {
                withSonarQubeEnv('sonar-server') {
                    sh """
                    $SONARQUBE_SCANNER_HOME/bin/sonar-scanner \
                    -Dsonar.projectKey=ott-platform-prime \
                    -Dsonar.projectName=ott-platform-prime \
                    # -Dsonar.sources=. \
                    # -Dsonar.host.url=http://13.213.72.83:9000 \
                    # -Dsonar.login=Sonar-token
                    """
                }
            }
        }

        stage('Quality Gate') {
            steps {
                waitForQualityGate abortPipeline: true, credentialsId: 'Sonar-token'
            }
        }
        
        stage('Trivy Scan') {
            steps {
                sh "trivy image --severity HIGH,CRITICAL --exit-code 1 --no-progress ott-platform-prime:latest > trivy_report.txt || true"
            }
        }

        stage("Docker Image Creation and push in ECR") {
            steps {
                sh "docker build -t ${params.ECR_REPO_NAME}:${params.IMAGE_TAG} ."
            }
        }

        stage("Create ECR REPOSITORY") {
            steps {
                withCredentials([string(credentialsId: 'aws-access-key', variable: 'AWS_ACCESS_KEY'), 
                string(credentialsId:'aws-secret-key', variable: 'AWS_SECRET_KEY')]) {
                    sh """
                    aws configure set aws_access_key_id ${AWS_ACCESS_KEY}
                    aws configure set aws_secret_access_key ${AWS_SECRET_KEY}
                    aws ecr describe-repositories --repository-names ${params.ECR_REPO_NAME} --region ${params.AWS_REGION} || \
                    aws ecr create-repository --repository-name ${params.ECR_REPO_NAME} --region ${params.AWS_REGION}
                    """
                }
            }
        }

        stage("Login to ECR and Push the image") {
            steps{
                withCredentials([string(credentialsId: 'aws-access-key', variable: 'AWS-ACCESS-KEY'),
                string(credentialsId:'aws-secret-key', variable: 'AWS-SECRET-KEY')]) {
                    sh """
                    aws ecr get-login-password --region ${params.AWS_REGION} | docker login --username AWS --password-stdin ${params.AWS_ACCOUNT_ID}.dkr.ecr.${params.AWS_REGION}.amazonaws.com
                    docker tag ${params.ECR_REPO_NAME}:${params.IMAGE_TAG} ${params.AWS_ACCOUNT_ID}.dkr.ecr.${params.AWS_REGION}.amazonaws.com/${params.ECR_REPO_NAME}:${BUILD_NUMBER}
                    docker push ${params.AWS_ACCOUNT_ID}.dkr.ecr.${params.AWS_REGION}.amazonaws.com/${params.ECR_REPO_NAME}:${BUILD_NUMBER}
                    """
                } 
            }
        }

        stage ("Deploy to Container") {
            steps {
                sh "sudo docker run -d --name ott-platform -p 3000:3000 ${params.AWS_ACCOUNT_ID}.dkr.ecr.${params.AWS_REGION}.amazonaws.com/${params.ECR_REPO_NAME}:${BUILD_NUMBER}"
            }
        }
        
        stage('Clean up the images') {
            steps{
                sh """
                docker rmi ${params.ECR_REPO_NAME}:${params.IMAGE_TAG} || true
                docker rmi ${params.AWS_ACCOUNT_ID}.dkr.ecr.${params.AWS_REGION}.amazonaws.com/${params.ECR_REPO_NAME}:${BUILD_NUMBER} || true
                """
            }
        }
    }

    post {
        always {
            emailext attachLog: true,
            subject: "'${currentBuild.result}'",
            body: """
                <html>
                <body>
                    <div style="background-color: #FFA07A; padding: 10px; margin-bottom: 10px;">
                        <p style="color: white; font-weight: bold;">Project: ${env.JOB_NAME}</p>
                    </div>
                    <div style="background-color: #90EE90; padding: 10px; margin-bottom: 10px;">
                        <p style="color: white; font-weight: bold;">Build Number: ${env.BUILD_NUMBER}</p>
                    </div>
                    <div style="background-color: #87CEEB; padding: 10px; margin-bottom: 10px;">
                        <p style="color: white; font-weight: bold;">URL: ${env.BUILD_URL}</p>
                    </div>
                </body>
                </html>
            """,
            to: 'mohanbhogi05@gmail.com',
            mimeType: 'text/html',
            attachmentsPattern: 'trivy_report.txt'
        }
    }   
}