pipeline{
    agent any
    
    parameters{
        string(name: 'ECR-REPO-NAME', defaultValue: 'ott-platform-prime', description: 'Enter the ECR repository name')
        string(name: 'IMAGE-TAG', defaultValue: 'latest', description: 'Enter the image tag')
        string(name: 'AWS-REGION', defaultValue: 'ap-southeast-1', description: 'Enter the AWS region')
        string(name: 'AWS-Account-ID', defaultValue: '859384797911', description: 'Enter the AWS account ID')
    }
    environment {
        SONARQUBE_SCANNER_HOME = tool 'sonar-scanner'
    }

    tools {
        nodejs "nodejs-16.20.0"
        jdk "jdk17"
    }


    stages{
        stage('Checkout Stage') {
            steps {
                git branch: 'main', url: 'https://github.com/krishnalogs/ott-platform-prime.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('Sonarqube Analysis') {
            steps {
                withSonarQubeEnv('sonar-server') {
                    sh """
                    $SONARQUBE_SCANNER_HOME/bin/sonar-scanner \
                    -Dsonar.projectKey=ott-platform-prime \
                    -Dsonar.projectName=ott-platform-prime \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=http://13.213.72.83:9000 \
                    -Dsonar.login=sonar-token
                    """
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time:1 , unit:'MINUTES'){
                    waitforQualityGate abortPipeline: true, credentialsId: 'sonar-token'
                }

            }
        }
        
        stage('Trivy Scan') {
            steps {
                sh "trivy image --severity HIGH,CRITICAL --exit-code 1 --no-progress ott-platform-prime:latest" > trivy_report.txt || true
            }
        }

        stage("Docker Image Creation and push in ECR") {
            steps {
                sh 'docker build -t ${params.ECR-REPO-NAME}:${params.IMAGE-TAG} .'
            }
        }

        stage("Create ECR REPOSITORY") {
            steps {
                withCredentials([string(credentialsId: 'aws-access-key', variable: 'AWS-ACCESS-KEY'), 
                string(credentialsId:'aws-secret-key', variable: 'AWS-SECRET-KEY')]) {
                    sh """
                    aws configure set aws_access_key_id ${AWS-ACCESS-KEY}
                    aws configure set aws_secret_access_key ${AWS-SECRET-KEY}
                    aws ecr describe-repositories --repository-names ${params.ECR-REPO-NAME} --region ap-southeast-1 || \
                    aws ecr create-repository --repository-name ${params.ECR-REPO-NAME} --region ap-southeast-1
                    """
                }
            }
        }

        stage("Login to ECR and Push the image") {
            steps{
                withCredentials([string(credentialsId: 'aws-access-key', variable: 'AWS-ACCESS-KEY'),
                string(credentialsId:'aws-secret-key', variable: 'AWS-SECRET-KEY')]) {
                    sh """
                    aws ecr get-login-password --region ${params.AWS-REGION} | docker login --username AWS --password-stdin ${params.AWS-Account-ID}.dkr.ecr.${params.AWS-REGION}.amazonaws.com
                    docker tag ${params.ECR-REPO-NAME}:${params.IMAGE-TAG} ${params.AWS-Account-ID}.dkr.ecr.${params.AWS-REGION}.amazonaws.com/${params.ECR-REPO-NAME}:${BUILD_NUMBER}
                    docker push ${params.AWS-Account-ID}.dkr.ecr.${params.AWS-REGION}.amazonaws.com/${params.ECR-REPO-NAME}:${BUILD_NUMBER}
                    """
                } 
            }
        }

        stage('Clean up the images') {
            steps{
                sh """
                docker rmi ${params.ECR-REPO-NAME}:${params.IMAGE-TAG} || true
                docker rmi ${params.AWS-Account-ID}.dkr.ecr.${params.AWS-REGION}.amazonaws.com/${params.ECR-REPO-NAME}:${BUILD_NUMBER} || true
                """
            }
        }
    }
}